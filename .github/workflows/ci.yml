name: CI/CD Pipeline

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run build
        run: bun run build

      - name: Run unit tests
        run: bun run test:unit

      - name: Install Playwright browsers
        run: bunx playwright install chromium --with-deps

      - name: Run E2E tests
        run: |
          # Start dev server in background
          bun run dev &
          SERVER_PID=$!

          # Wait for server to start on port 4321
          echo "Waiting for server to start..."
          timeout 30 bash -c 'until curl -s http://localhost:4321 > /dev/null; do sleep 1; done' || exit 1

          # Run E2E tests
          bun run test:e2e

          # Kill server
          kill $SERVER_PID

      - name: Report test results
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… All tests passed!"
          else
            echo "âŒ Tests failed!"
            exit 1
          fi

  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail build on type errors (warning only)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Type check (warning only)
        run: bunx tsc --noEmit || echo "âš ï¸ Type check failed but continuing..."

  lint-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Check for console.logs
        run: |
          if grep -r "console.log" src/ --exclude-dir=node_modules; then
            echo "âš ï¸ Found console.log statements. Consider removing them."
            exit 0  # Warning only, don't fail
          else
            echo "âœ… No console.log statements found"
          fi

      - name: Check for TODO comments
        run: |
          TODO_COUNT=$(grep -r "TODO" src/ --exclude-dir=node_modules | wc -l || echo "0")
          echo "Found $TODO_COUNT TODO comments"
          if [ "$TODO_COUNT" -gt 10 ]; then
            echo "âš ï¸ High number of TODO comments found"
          fi

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Check for outdated dependencies
        run: bun outdated || true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, type-check]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "# ðŸ“Š CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build & Test**: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type Check**: ${{ needs.type-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build-and-test.result }}" == "success" && "${{ needs.type-check.result }}" == "success" ]]; then
            echo "âœ… All checks passed! Ready to merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
          fi
